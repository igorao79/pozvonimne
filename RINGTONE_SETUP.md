# Настройка функции пользовательских рингтонов

## Обзор функциональности

Пользователи могут загружать собственные рингтоны, которые будут воспроизводиться при входящих звонках. Рингтоны хранятся в облачном хранилище Mega.nz, а ссылки сохраняются в базе данных Supabase.

## Пошаговая настройка

### 1. Настройка Mega.nz

1. Перейдите на [mega.nz](https://mega.nz) и создайте бесплатный аккаунт
2. Получите 20GB бесплатного хранилища
3. Запомните email и пароль для настройки

### 2. Настройка переменных окружения

1. Скопируйте файл `.env.example` в `.env.local`:
   ```bash
   cp .env.example .env.local
   ```

2. Отредактируйте `.env.local` и добавьте ваши данные Mega.nz:
   ```
   MEGA_EMAIL=your_mega_email@example.com
   MEGA_PASSWORD=your_mega_password
   ```

### 3. Настройка базы данных

Выполните SQL скрипт `add_ringtone_field.sql` в Supabase Dashboard:

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Скопируйте и выполните содержимое файла `add_ringtone_field.sql`

Этот скрипт добавит поле `ringtone_key` в таблицу `user_profiles`.

### 4. Перезапуск сервера

После настройки переменных окружения перезапустите сервер разработки:

```bash
npm run dev
```

## Как использовать

### Для пользователей:

1. **Открытие настроек**: Нажмите на иконку шестеренки рядом с профилем
2. **Загрузка рингтона**: 
   - Нажмите "Загрузить новый рингтон"
   - Выберите аудиофайл (MP3, WAV, OGG, до 10MB)
   - Дождитесь завершения загрузки
3. **Тестирование**: Используйте кнопку "Прослушать" для проверки
4. **Удаление**: При необходимости удалите рингтон кнопкой "Удалить"

### Технические детали:

- **Поддерживаемые форматы**: MP3, WAV, OGG, M4A, FLAC
- **Максимальный размер**: 10MB
- **Хранение**: Mega.nz (папка `ringtones/{userId}/`)
- **База данных**: Ссылка хранится в `user_profiles.ringtone_key`

## Архитектура

### Структура папок в Mega.nz:
```
ringtones/
  ├── user_id_1/
  │   └── ringtone_timestamp.mp3
  ├── user_id_2/
  │   └── ringtone_timestamp.wav
  └── ...
```

### API Endpoints:

- `POST /api/ringtones/upload` - Загрузка рингтона
- `DELETE /api/ringtones/remove` - Удаление рингтона  
- `GET /api/ringtones/get?userId=xxx` - Получение ссылки на рингтон

### Компоненты:

- `RingtoneSettings` - Модальное окно настроек
- `IncomingCall` - Компонент входящего звонка с воспроизведением рингтона

## Преимущества использования Mega.nz

1. **Бесплатно**: 20GB хранилища без платы
2. **Безопасность**: Приватное хранение файлов
3. **Надежность**: Стабильные ссылки для скачивания
4. **Простота**: Легкая интеграция через megajs SDK

## Troubleshooting

### Проблема: "Настройки Mega.nz не настроены"
**Решение**: Проверьте переменные MEGA_EMAIL и MEGA_PASSWORD в .env.local

### Проблема: "Ошибка подключения к Mega.nz"
**Решение**: 
- Проверьте правильность email и пароля
- Убедитесь что аккаунт Mega активен
- Проверьте интернет-соединение

### Проблема: "Не удалось воспроизвести рингтон"
**Решение**:
- Проверьте формат файла (должен поддерживаться браузером)
- Убедитесь что файл не поврежден
- Проверьте настройки звука в браузере

## Дополнительные возможности

В будущем можно добавить:
- Предустановленные рингтоны
- Обрезка аудио до нужной длины
- Громкость рингтона
- Различные рингтоны для разных контактов
