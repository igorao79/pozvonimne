# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö Supabase –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è "–ü–æ–∑–≤–æ–Ω–∏.–º–Ω–µ"

## üìã –ü–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL —Å–∫—Ä–∏–ø—Ç–æ–≤

### 1. **–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–º)
**–§–∞–π–ª:** `create_user_profiles.sql`
- –°–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `user_profiles`
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –∏ –ø–æ–ª–∏—Ç–∏–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- –°–æ–∑–¥–∞–µ—Ç bucket –¥–ª—è –∞–≤–∞—Ç–∞—Ä–æ–∫
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~5 —Å–µ–∫—É–Ω–¥

### 2. **–¢—Ä–∏–≥–≥–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π** (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ –≤—Ç–æ—Ä—ã–º)
**–§–∞–π–ª:** `create_profile_trigger.sql`
- –°–æ–∑–¥–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π
- –¢—Ä–∏–≥–≥–µ—Ä **–û–¢–ö–õ–Æ–ß–ï–ù** –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~2 —Å–µ–∫—É–Ω–¥—ã

### 3. **–§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏** (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Ç—Ä–µ—Ç—å–∏–º)
**–§–∞–π–ª:** `update_profile_functions.sql`
- –°–æ–∑–¥–∞–µ—Ç –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—Ä–æ—Ñ–∏–ª—è–º–∏
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~10 —Å–µ–∫—É–Ω–¥

### 4. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π** (–≤—ã–ø–æ–ª–Ω–∏—Ç–µ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
**–§–∞–π–ª:** `update_username.sql`
- –û–±–Ω–æ–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `update_username()`
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –ª–æ–≥–∏–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è username

**–§–∞–π–ª:** `update_display_name.sql`
- –î–æ–±–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `update_display_name()`
- **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–≥–æ –∏–º–µ–Ω–∏

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### –î–ª—è –Ω–æ–≤–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
```bash
1. create_user_profiles.sql
2. create_profile_trigger.sql
3. update_profile_functions.sql
```

### –î–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑—ã:
```bash
1. update_profile_functions.sql (–æ–±–Ω–æ–≤–∏—Ç –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏)
2. update_username.sql (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å username)
3. update_display_name.sql (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å display_name)
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `user_profiles`
```sql
id              UUID PRIMARY KEY (—Å—Å—ã–ª–∫–∞ –Ω–∞ auth.users)
username        TEXT UNIQUE (3-20 —Å–∏–º–≤–æ–ª–æ–≤, –±—É–∫–≤—ã/—Ü–∏—Ñ—Ä—ã/_)
display_name    TEXT (–æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è)
avatar_url      TEXT (—Å—Å—ã–ª–∫–∞ –Ω–∞ –∞–≤–∞—Ç–∞—Ä–∫—É)
status          TEXT (online/offline)
last_seen       TIMESTAMPTZ (–ø–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å)
created_at      TIMESTAMPTZ (—Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è)
updated_at      TIMESTAMPTZ (–ø–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ)
```

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

#### `get_users_with_profiles()`
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏—Ö –ø—Ä–æ—Ñ–∏–ª—è–º–∏ –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤.

#### `update_username(new_username TEXT)`
–û–±–Ω–æ–≤–ª—è–µ—Ç username –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏.

#### `update_display_name(new_display_name TEXT)`
–û–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

#### `ensure_user_profile()`
–°–æ–∑–¥–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏.

#### `initialize_user_profile()`
–°–æ–∑–¥–∞–µ—Ç –±–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –±–µ–∑ username.

#### `update_user_last_seen()`
–û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

## üîß –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π –≤ SQL Editor:
```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Ñ–∏–ª–µ–π
SELECT COUNT(*) FROM user_profiles;

-- –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT username, display_name, status FROM get_users_with_profiles() LIMIT 5;

-- –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ username
SELECT update_username('testuser123');
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞:
```sql
-- –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–ª–∏—Ç–∏–∫–∏ RLS
SELECT schemaname, tablename, policyname FROM pg_policies WHERE tablename = 'user_profiles';
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### 1. **–¢—Ä–∏–≥–≥–µ—Ä –æ—Ç–∫–ª—é—á–µ–Ω –Ω–∞–º–µ—Ä–µ–Ω–Ω–æ**
–¢—Ä–∏–≥–≥–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π –æ—Ç–∫–ª—é—á–µ–Ω, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –æ—à–∏–±–∫–∏ 500 –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü—Ä–æ—Ñ–∏–ª–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏–∏ `ensure_user_profile()` –∏ `initialize_user_profile()`.

### 2. **Username –º–æ–∂–µ—Ç –±—ã—Ç—å NULL**
–ü–æ–ª–µ `username` nullable, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª–∏ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å `username = NULL` –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤.

### 3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è username**
–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ `ensure_user_profile()` username –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑ `display_name` –∏–ª–∏ email.

### 4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- –í–∫–ª—é—á–µ–Ω–∞ Row Level Security (RLS)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç —á–∏—Ç–∞—Ç—å –≤—Å–µ –ø—Ä–æ—Ñ–∏–ª–∏, –Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —Å–≤–æ–π
- –§—É–Ω–∫—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ (SECURITY DEFINER)

## üêõ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –û—à–∏–±–∫–∞ "already exists"
```sql
-- –£–¥–∞–ª–∏—Ç–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –æ–±—ä–µ–∫—Ç—ã
DROP FUNCTION IF EXISTS function_name();
DROP POLICY IF EXISTS policy_name ON table_name;
```

### –û—à–∏–±–∫–∞ "violates foreign key constraint"
```sql
-- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ auth.users
SELECT id, email FROM auth.users WHERE email_confirmed_at IS NOT NULL;
```

### –§—É–Ω–∫—Ü–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç
```sql
-- –ü–µ—Ä–µ—Å–æ–∑–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏
-- –í—ã–ø–æ–ª–Ω–∏—Ç–µ update_profile_functions.sql
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Supabase
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–≤
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** $(date)
**–í–µ—Ä—Å–∏—è:** 1.0.0

