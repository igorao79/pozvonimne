import { useRef, useCallback, useEffect } from 'react'

interface UseChatScrollProps {
  messagesLength: number
  loading: boolean
}

export const useChatScroll = ({ messagesLength, loading }: UseChatScrollProps) => {
  const messagesEndRef = useRef<HTMLDivElement>(null)

  // Ð¡ÐºÑ€Ð¾Ð»Ð» Ðº Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¼Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑŽ
  const scrollToBottom = useCallback(() => {
    if (messagesEndRef.current) {
      // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ requestAnimationFrame Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ¹ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      requestAnimationFrame(() => {
        messagesEndRef.current?.scrollIntoView({
          behavior: 'smooth',
          block: 'end',
          inline: 'nearest'
        })
      })
    }
  }, [])

  // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾ÐºÑ€ÑƒÑ‚ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
  useEffect(() => {
    if (!loading && messagesLength > 0) {
      console.log('ðŸ“œ ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾ÐºÑ€ÑƒÑ‚ÐºÐ° Ðº Ð½Ð¸Ð·Ñƒ Ð¿Ð¾ÑÐ»Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸, ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹:', messagesLength)
      // ÐÐµÐ±Ð¾Ð»ÑŒÑˆÐ°Ñ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ° Ð´Ð»Ñ Ñ‚Ð¾Ð³Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ DOM Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ð»ÑÑ
      const timeoutId = setTimeout(() => {
        scrollToBottom()
      }, 100)
      return () => clearTimeout(timeoutId)
    }
  }, [messagesLength, loading, scrollToBottom])

  // ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
  useEffect(() => {
    if (messagesLength > 0) {
      const lastMessage = messagesLength
      // ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‡Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð½Ð¸Ð· Ð´Ð»Ñ Ð²ÑÐµÑ… Ð½Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
      console.log('ðŸ“œ ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚ÐºÐ° Ðº Ð½Ð¾Ð²Ð¾Ð¼Ñƒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑŽ')
      const timeoutId = setTimeout(() => {
        scrollToBottom()
      }, 50)
      return () => clearTimeout(timeoutId)
    }
  }, [messagesLength, scrollToBottom])

  // ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚ÐºÐ° Ðº Ð½Ð¸Ð·Ñƒ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð²Ñ…Ð¾Ð´Ðµ Ð² Ñ‡Ð°Ñ‚ (Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹ Ð½ÐµÑ‚)
  useEffect(() => {
    if (!loading) {
      console.log('ðŸ“œ ÐŸÑ€Ð¾ÐºÑ€ÑƒÑ‚ÐºÐ° Ðº Ð½Ð¸Ð·Ñƒ Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ Ð² Ñ‡Ð°Ñ‚')
      const timeoutId = setTimeout(() => {
        scrollToBottom()
      }, 50)
      return () => clearTimeout(timeoutId)
    }
  }, [loading, scrollToBottom])

  return {
    messagesEndRef,
    scrollToBottom
  }
}
